# Схема работы функции Дуа

## Диаграмма потока данных

```
┌─────────────────────────────────────────────────────────────┐
│                   Пользователь нажимает                      │
│                    "Оставить дуа"                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│           Проверка лимита пользователя (2 дуа)              │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌──────────────┐           ┌──────────────────┐
│  Превышен?   │           │  Не превышен     │
│  Да          │           │                  │
│              │           │  Продолжить      │
└──────┬───────┘           └────────┬─────────┘
       │                            │
       │                            ▼
       │              ┌──────────────────────────────┐
       │              │  Проверка общего лимита (20) │
       │              └────────┬─────────────────────┘
       │                       │
       │         ┌─────────────┴─────────────┐
       │         │                           │
       │         ▼                           ▼
       │  ┌──────────────┐           ┌──────────────────┐
       │  │  Превышен?   │           │  Осталось < 5?   │
       │  │  Да          │           │                  │
       │  │              │           │                  │
       │  └──────┬───────┘           └────────┬─────────┘
       │         │                            │
       │         │                  ┌─────────┴──────────┐
       │         │                  │                    │
       │         │                  ▼                    ▼
       │         │          ┌──────────────┐    ┌──────────────┐
       │         │          │ Предупреждение│    │ Без предупр. │
       │         │          │ + выбор       │    │              │
       │         │          └──────┬────────┘    └──────┬───────┘
       │         │                 │                    │
       ▼         ▼                 ▼                    │
┌─────────────────────────────────────────────────┐    │
│           Показать сообщение об ошибке          │    │
│           и кнопку "Назад"                      │    │
└─────────────────────────────────────────────────┘    │
                                                       │
                      ┌────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Запрос: "От какого имени?"                      │
│                                                              │
│  [ Моё имя ]  [ Анонимно ]  [ Назад ]                       │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌──────────────┐           ┌──────────────────┐
│  Моё имя     │           │  Анонимно        │
│              │           │                  │
│  Берется из  │           │  Имя = "Аноним"  │
│  профиля     │           │                  │
└──────┬───────┘           └────────┬─────────┘
       │                            │
       └─────────────┬──────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              Состояние: WAITING_DUA                          │
│              Запрос: "Введите текст дуа"                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│            Пользователь вводит текст дуа                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│          Повторная проверка лимитов                          │
│          (на случай race condition)                          │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌──────────────┐           ┌──────────────────────────────┐
│  Превышен?   │           │  Не превышен                 │
│  Да          │           │                              │
│              │           │  1. Сохранить в БД           │
│  Ошибка      │           │  2. Отправить админу         │
└──────────────┘           │  3. Подтверждение юзеру      │
                           │  4. Вернуться в главное меню │
                           └──────────────────────────────┘
```

## Ключевые компоненты

### 1. Проверка лимитов
- **Функция**: `count_user_duas_this_juma()` - подсчет дуа пользователя
- **Функция**: `count_total_duas_this_juma()` - подсчет всех дуа
- **Лимит пользователя**: 2 дуа на Жума
- **Общий лимит**: 20 дуа на Жума

### 2. Определение недели Жума
- **Функция**: `get_current_juma_week()`
- **Формат**: YYYY-WW (например: 2025-12)
- **Логика**: находит ближайшую пятницу и берет номер недели

### 3. FSM состояния
- **WAITING_DUA_NAME_CHOICE** - выбор имени
- **WAITING_DUA** - ввод текста дуа
- **IN_MARATHON** - возврат в основное меню

### 4. Callback handlers
- `send_dua` - начало процесса
- `dua_confirm_send` - подтверждение при предупреждении
- `dua_name_real` - выбор реального имени
- `dua_name_anonymous` - выбор анонимности
- `main_menu` - возврат в меню

### 5. Message handler
- `receive_dua_text()` - обработка текста дуа

## База данных

### Таблица `duas`
```sql
CREATE TABLE duas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    text TEXT NOT NULL,
    sender_name TEXT NOT NULL,
    is_anonymous INTEGER DEFAULT 0,
    juma_week TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
)
```

## Многоязычность

Поддерживаемые языки:
- `uz_latin` - O'zbekcha (латиница)
- `uz_cyrillic` - O'zbekcha (кириллица)
- `ru` - Русский

Все тексты хранятся в `bot/locales/texts.py`
